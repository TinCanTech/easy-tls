#!/bin/sh

# Connection tacking - Connect
conn_trac_connect ()
{
	[ -n "${1}" ] || return 1
	EASYTLS_CONN_TRAC_TEMP="${EASYTLS_CONN_TRAC}.tmp"
	if [ -f "${EASYTLS_CONN_TRAC}" ] && \
		"${EASYTLS_GREP}" -q "^${1}\$" "${EASYTLS_CONN_TRAC}"
	then
		# Already connected don't add another
		update_status "conn-trac: already registered"
		[ $VERBOSE_CONN_TRAC ] && update_status "${1}"
	else
		{	# Add tlskey_serial to Easy-TLS Conn-Trac file
			"${EASYTLS_PRINTF}" "%s\n" "${1}"
			[ -f "${EASYTLS_CONN_TRAC}" ] && \
				"${EASYTLS_CAT}" "${EASYTLS_CONN_TRAC}"
		} > "${EASYTLS_CONN_TRAC_TEMP}"
		"${EASYTLS_MV}" -f \
			"${EASYTLS_CONN_TRAC_TEMP}" "${EASYTLS_CONN_TRAC}" || return 1
		update_status "conn-trac: registered"
		[ $VERBOSE_CONN_TRAC ] && update_status "${1}"
	fi
	unset EASYTLS_CONN_TRAC_TEMP
} # => conn_trac_connect ()

# Update connection tacking - disconnect
conn_trac_disconnect ()
{
	[ -n "${1}" ] || return 1
	if [ -f "${EASYTLS_CONN_TRAC}" ] && \
		"${EASYTLS_GREP}" -q "^${1}\$" "${EASYTLS_CONN_TRAC}"
	then
		"${EASYTLS_SED}" -i -e "/^${1}\$/d" "${EASYTLS_CONN_TRAC}" # -e "/^\$/d"
		update_status "conn-trac: unregistered"
		[ $VERBOSE_CONN_TRAC ] &&  update_status "${1}"
		[ -s "${EASYTLS_CONN_TRAC}" ] || "${EASYTLS_RM}" -f "${EASYTLS_CONN_TRAC}"
	else
		[ $VERBOSE_CONN_TRAC ] && update_status "${1}"
		return 1
	fi
} # => conn_trac_disconnect ()
