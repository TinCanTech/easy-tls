#!/bin/sh

# Experimental - Use at your own risk

# Copyright - negotiable
copyright ()
{
: << VERBATUM_COPYRIGHT_HEADER_INCLUDE_NEGOTIABLE
# easytls-conntrac.lib -- Do simple magic
#
# Copyright (C) 2020 Richard Bonhomme (Friday 13th of March 2020)
# https://github.com/TinCanTech/easy-tls
# tincantech@protonmail.com
# All Rights reserved.
#
# This code is released under version 2 of the GNU GPL
# See LICENSE of this project for full licensing details.
#
# Connection tracking.
#
VERBATUM_COPYRIGHT_HEADER_INCLUDE_NEGOTIABLE
}

# Simple lock file
acquire_lock ()
{
	exec 2>/dev/null
	set -o noclobber
	exec 8> "${easytls_ct_lock_file}" || return 1
	printf "%s" "$$" >&8 || return 1
	exec 8< "${easytls_ct_lock_file}" || return 1
	set +o noclobber
	[ ! $VERBOSE_CONN_TRAC ] || update_status "conntrac: acquire_lock"
}

release_lock ()
{
	exec 8<&- || return 1
	exec 8>&- || return 1
	"${EASYTLS_RM}" -f "${easytls_ct_lock_file}"
	[ ! $VERBOSE_CONN_TRAC ] || update_status "conntrac: release_lock"
}

# Connection tacking - Connect
conn_trac_connect ()
{
	[ -n "${1}" ] || return 1
	[ -n "${2}" ] || return 1
	easytls_ct_lock_file="${2}.lock"
	easytls_temp_file="${2}.tmp"
	easytls_ct_log="${2}.log"
	unset err_exit record_found ct_ig_ipp_ex ct_tlskey_found

	acquire_lock || return 9

	if [ $ENABLE_CONN_TRAC_STATS ]
	then
		conn_trac_stats || {
			update_status "conntrac: stats fail"
			release_lock || return 9
			}
	fi

	# Patterns to match - Anything after ++ cannot be used
	ct_pattern="${1%++*}"
	[ $VERBOSE_CONN_TRAC ] && \
		update_status "conntrac: pattern ${ct_pattern}"

	ct_tlskey="${1%%=*}"
	[ "${ct_tlskey}" = "TLSAC" ] && unset ct_tlskey

	if [ -f "${2}" ]
	then
		{
			while read full_conn
			do
				conn="${full_conn%++*}"
				tksn="${full_conn%%=*}"

				[ ! "${tksn}" = "${ct_tlskey}" ] || ct_tlskey_found=1

				if [ "${conn}" = "${ct_pattern}" ]
				then
					"${EASYTLS_PRINTF}" '%s\n' "${full_conn}"
					[ $record_found ] || \
						update_status "conntrac: already registered"
					[ $ip_pool_exhausted ] && \
						ct_ig_ipp_ex="${ct_ig_ipp_ex} X"
					record_found=1
				else
					# Print the existing record
					"${EASYTLS_PRINTF}" '%s\n' "${full_conn}"
				fi
			done < "${2}"

			# Always register the record
			"${EASYTLS_PRINTF}" "%s\n" "${1}"

			# Add Ignore stats
			[ -z "${ct_ig_ipp_ex}" ] || {
				update_status "IGN-IPP-EX:${ct_ig_ipp_ex}"
				tlskey_status "* TLSK-DUP: ${ct_ig_ipp_ex} >"
				}

		} > "${easytls_temp_file}" || err_exit=1

		"${EASYTLS_MV}" -f "${easytls_temp_file}" "${2}" || err_exit=1

		if [ $record_found ]
		then
			err_exit=${err_exit:-2}
		else
			update_status "conntrac: registered"
		fi
	else
		# conntrac file does not exist, create it now
		{
			"${EASYTLS_PRINTF}" "%s\n" "${1}"
		} > "${2}" || err_exit=1
		update_status "conntrac: registered OPENED"
		tlskey_status "*conntrac: registered OPENED >"
	fi
	release_lock || return 9

	err_exit=${err_exit:-0}
	[ $err_exit -eq 0 ] && [ $ct_tlskey_found ] && err_exit=6
	unset easytls_ct_lock_file easytls_temp_file conn \
			record_found ct_ig_ipp_ex ct_tlskey_found
	return ${err_exit}
} # => conn_trac_connect ()

# Update connection tacking - disconnect
conn_trac_disconnect ()
{
	[ -n "${1}" ] || return 1
	[ -n "${2}" ] || return 1
	easytls_ct_lock_file="${2}.lock"
	easytls_temp_file="${2}.tmp"
	easytls_ct_log="${2}.log"
	unset err_exit record_found ct_ig_ipp_ex

	acquire_lock || return 9

	if [ $ENABLE_CONN_TRAC_STATS ]
	then
		conn_trac_stats || {
			update_status "conntrac: stats fail"
			release_lock || return 9
			}
	fi

	# Pattern to match - Anything after ++ cannot be used
	ct_pattern="${1%++*}"
	[ $VERBOSE_CONN_TRAC ] && \
		update_status "conntrac pattern: ${ct_pattern}"

	if [ -f "${2}" ]
	then
		{
			while read full_conn
			do
				conn="${full_conn%++*}"
				if [ "${conn}" = "${ct_pattern}" ]
				then
					# If record_found then a record has been deleted
					# Print the remaining duplicates
					[ $record_found ] && \
						"${EASYTLS_PRINTF}" '%s\n' "${full_conn}"
					[ $record_found ] && [ $ip_pool_exhausted ] && \
						ct_ig_ipp_ex="${ct_ig_ipp_ex} X"
					# Matched - Do not Print
					[ $record_found ] || \
						update_status "conntrac: unregistered"
					record_found=1
				else
					# No match - Print current record
					"${EASYTLS_PRINTF}" '%s\n' "${full_conn}"
				fi
			done < "${2}"

			# Add Ignore stats
			[ -z "${ct_ig_ipp_ex}" ] || {
				update_status "IGN-IPP-EX:${ct_ig_ipp_ex}"
				tlskey_status "* TLSK-DUP:${ct_ig_ipp_ex} >"
				}

		} > "${easytls_temp_file}" || err_exit=1

		"${EASYTLS_MV}" -f "${easytls_temp_file}" "${2}" || err_exit=1

		[ $record_found ] || {
			update_status "conntrac: record not found"
			err_exit=${err_exit:-2}
			}
		[ -s "${2}" ] || {
			"${EASYTLS_RM}" -f "${2}"
			update_status "conntrac: RESET"
			tlskey_status "* conntrac: RESET >"
			}
	else
		update_status "conntrac: file not found"
		err_exit=3
	fi
	release_lock || return 9

	err_exit=${err_exit:-0}
	unset easytls_ct_lock_file easytls_temp_file conn \
			record_found ct_ig_ipp_ex
	return ${err_exit}
} # => conn_trac_disconnect ()

conn_trac_stats ()
{
	ctc=0
	[ -f "${easytls_ct_log}" ] && ctc="$("${EASYTLS_CAT}" "${easytls_ct_log}")"
	[ $(( ctc )) -lt 32768 ] || ctc=0
	ctc=$(( ctc + 1 ))
	"${EASYTLS_PRINTF}" '%s\n' "${ctc}" > "${easytls_temp_file}" || return 1
	"${EASYTLS_MV}" -f "${easytls_temp_file}" "${easytls_ct_log}" || return 1
	update_status "conntrac: tallied"
}
