#!/bin/sh

# Experimental - Use at your own risk

# Copyright - negotiable
copyright ()
{
: << VERBATUM_COPYRIGHT_HEADER_INCLUDE_NEGOTIABLE
# easytls-conntrac.lib -- Do simple magic
#
# Copyright (C) 2020 Richard Bonhomme (Friday 13th of March 2020)
# https://github.com/TinCanTech/easy-tls
# tincantech@protonmail.com
# All Rights reserved.
#
# This code is released under version 2 of the GNU GPL
# See LICENSE of this project for full licensing details.
#
# Connection tracking.
#
VERBATUM_COPYRIGHT_HEADER_INCLUDE_NEGOTIABLE
}

# Simple lock file
acquire_lock ()
{
	exec 2>/dev/null
	set -o noclobber
	exec 8> "${easytls_ct_lock_file}" || return 1
	printf "%s" "$$" >&8 || return 1
	exec 8< "${easytls_ct_lock_file}" || return 1
	set +o noclobber
}

release_lock ()
{
	exec 8<&- || return 1
	exec 8>&- || return 1
	"${EASYTLS_RM}" -f "${easytls_ct_lock_file}"
}

# Connection tacking - Connect
conn_trac_connect ()
{
	# Currently, this cannot correctly process TLS-AUTH/Crypt plus --duplicate-cn
	[ -n "${1}" ] || return 1
	[ -n "${2}" ] || return 1
	easytls_ct_lock_file="${2}.lock"
	easytls_temp_file="${2}.tmp"
	acquire_lock || die "ct acquire_lock"
	unset err_exit
	conn_trac_count

	# Pattern to match
	conntrac_pattern="${1}"

	if [ -f "${2}" ]
	then
		{
			while read full_conn
			do
				conn="${full_conn}"
				if [ "${conn}" = "${conntrac_pattern}" ]
				then
					# Already exists - Print nothing
					already_registered=1
					update_status "conntrac: already registered"
					[ $VERBOSE_CONN_TRAC ] && update_status "${1}"
				else
					# Print the existing record
					"${EASYTLS_PRINTF}" '%s\n' "${full_conn}"
				fi
			done < "${2}"
			# If not already registered then print it
			[ $already_registered ] || "${EASYTLS_PRINTF}" "%s\n" "${1}"
		} > "${easytls_temp_file}" || err_exit=1

		"${EASYTLS_MV}" -f "${easytls_temp_file}" "${2}" || err_exit=1

		if [ $already_registered ]
		then
			err_exit=${err_exit:-2}
		else
			update_status "conn-trac: registered"
			[ $VERBOSE_CONN_TRAC ] && update_status "${1}"
		fi
	else
		# conntrac file does not exist, create it now
		{
			"${EASYTLS_PRINTF}" "%s\n" "${1}"
		} > "${2}" || err_exit=1
		update_status "conn-trac: registered"
		[ $VERBOSE_CONN_TRAC ] && update_status "${1}"
	fi
	release_lock || die "ct release_lock"
	unset easytls_ct_lock_file easytls_temp_file conn already_registered
	err_exit=${err_exit:-0}
	return ${err_exit}
} # => conn_trac_connect ()

# Update connection tacking - disconnect
conn_trac_disconnect ()
{
	[ -n "${1}" ] || return 1
	[ -n "${2}" ] || return 1
	easytls_ct_lock_file="${2}.lock"
	easytls_temp_file="${2}.tmp"
	acquire_lock || die "ct acquire_lock"
	unset err_exit
	conn_trac_count

	# Pattern to match
	conntrac_pattern="${1%++*}"

	if [ -f "${2}" ]
	then
		{
			while read full_conn
			do
				conn="${full_conn%++*}"
				if [ "${conn}" = "${conntrac_pattern}" ]
				then
					# Matched - Do not Print
					conntrac_updated=1
					update_status "conntrac: unregistered"
					[ $VERBOSE_CONN_TRAC ] && update_status "${1}"
				else
					# No match - Print
					"${EASYTLS_PRINTF}" '%s\n' "${full_conn}"
				fi
			done < "${2}"
		} > "${easytls_temp_file}" || err_exit=1

		"${EASYTLS_MV}" -f "${easytls_temp_file}" "${2}" || err_exit=1

		[ $conntrac_updated ] || {
			update_status "conntrac: record not found"
			[ $VERBOSE_CONN_TRAC ] && update_status "${1}"
			err_exit=${err_exit:-2}
			}
		[ -s "${2}" ] || {
			"${EASYTLS_RM}" -f "${2}"
			update_status "conntrac: RESET"
			}
	else
		update_status "conntrac: file not found"
		[ $VERBOSE_CONN_TRAC ] && update_status "${1}"
		err_exit=1
	fi
	release_lock || die "ct release_lock"
	unset easytls_ct_lock_file easytls_temp_file conn conntrac_updated
	err_exit=${err_exit:-0}
	return ${err_exit}
} # => conn_trac_disconnect ()

conn_trac_count ()
{
	ctc=0
	easytls_ct_count="${temp_stub}-conn-trac.log"
	[ -f "${easytls_ct_count}" ] && \
		ctc="$("${EASYTLS_CAT}" "${easytls_ct_count}")"
	ctc=$(( ctc + 1 ))
	"${EASYTLS_PRINTF}" '%s\n' "${ctc}" > "${easytls_temp_file}" || err_exit=1
	"${EASYTLS_MV}" -f "${easytls_temp_file}" "${easytls_ct_count}" || err_exit=1
}
