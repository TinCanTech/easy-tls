## #!/bin/sh

# Copyright - negotiable
copyright ()
{
: << VERBATUM_COPYRIGHT_HEADER_INCLUDE_NEGOTIABLE
# easytls-metadata.lib -- Do simple magic
#
# Copyright (C) 2020 Richard Bonhomme (Friday 13th of March 2020)
# https://github.com/TinCanTech/easy-tls
# tincantech@protonmail.com
# All Rights reserved.
#
# This code is released under version 2 of the GNU GPL
# See LICENSE of this project for full licensing details.
#
# Process TLS-Crypt-V2 metadata.
#
VERBATUM_COPYRIGHT_HEADER_INCLUDE_NEGOTIABLE
}

# Break metadata_string into variables
# shellcheck disable=SC2034
metadata_string_to_vars ()
{
	tlskey_serial="${1%%-*}"
	[ $generic_metadata ] && g_tlskey_serial=${tlskey_serial} && unset tlskey_serial
	[ $client_metadata ] && c_tlskey_serial=${tlskey_serial} && unset tlskey_serial

	[ $key_metadata ] && seed="${*}" && md_seed="${seed#*-}" && unset seed
	#md_padding="${md_seed%%--*}"
	[ $key_metadata ] && md_easytls_ver="${1#*--}"
	[ $key_metadata ] && md_easytls="${md_easytls_ver%-*}" && unset md_easytls_ver

	[ $key_metadata ] && md_identity="${2%%-*}"
	#md_srv_name="${2##*-}"

	md_serial="${3}"
	[ $generic_metadata ] && g_md_serial=${md_serial} && unset md_serial
	[ $client_metadata ] && c_md_serial=${md_serial} && unset md_serial

	if [ $key_metadata ]
	then
		md_date="${4}"
		md_custom_g="${5}"
		md_name="${6}"
		md_subkey="${7}"
		md_opt="${8}"
	fi

	md_hwadds="${9}"
	[ $generic_metadata ] && g_md_hwadds=${md_hwadds} && unset md_hwadds
	[ $client_metadata ] && c_md_hwadds=${md_hwadds} && unset md_hwadds

	return 0
} # => metadata_string_to_vars ()

# shellcheck disable=SC2154 # metadata_string
key_metadata_string_to_vars ()
{
	key_metadata=1
	metadata_string_to_vars $metadata_string || return 1
	unset metadata_string key_metadata
}

generic_metadata_string_to_vars ()
{
	generic_metadata=1
	metadata_string_to_vars $metadata_string || return 1
	unset metadata_string generic_metadata tlskey_serial md_serial
}

client_metadata_string_to_vars ()
{
	client_metadata=1
	metadata_string_to_vars $metadata_string || return 1
	unset metadata_string client_metadata tlskey_serial md_serial
}
